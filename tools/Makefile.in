#
# Copyright (C) 2001-2003 Sistina Software
#
# This LVM library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Library General Public
# License as published by the Free Software Foundation; either
# version 2 of the License, or (at your option) any later version.
#
# This LVM library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Library General Public License for more details.
#
# You should have received a copy of the GNU Library General Public
# License along with this LVM library; if not, write to the Free
# Software Foundation, Inc., 59 Temple Place - Suite 330, Boston,
# MA 02111-1307, USA

srcdir = @srcdir@
top_srcdir = @top_srcdir@
VPATH = @srcdir@

SOURCES=\
	archiver.c \
	dumpconfig.c \
	lvchange.c \
	lvcreate.c \
	lvdisplay.c \
	lvextend.c \
	lvmchange.c \
	lvmcmdline.c \
	lvmdiskscan.c \
	lvreduce.c \
	lvremove.c \
	lvrename.c \
	lvresize.c \
	lvscan.c \
	pvchange.c \
	pvcreate.c \
	pvdisplay.c \
	pvmove.c \
	pvremove.c \
	pvscan.c \
	reporter.c \
	toollib.c \
	vgcfgbackup.c \
	vgcfgrestore.c \
	vgchange.c \
	vgck.c \
	vgcreate.c \
	vgconvert.c \
	vgdisplay.c \
	vgexport.c \
	vgextend.c \
	vgimport.c \
	vgmerge.c \
	vgmknodes.c \
	vgreduce.c \
	vgremove.c \
	vgrename.c \
	vgscan.c \
	vgsplit.c

TARGETS=\
	.commands \
	lvm

LVMLIBS=-llvm

INSTALL_TARGETS=\
	install_lvm_tools

CLEAN_TARGETS = liblvm2cmd.so liblvm2cmd.a

ifeq ("@CMDLIB@", "yes")
	TARGETS += liblvm2cmd.so
	INSTALL_TARGETS += install_cmdlib
endif

ifeq ("@DEVMAPPER@", "yes")
	LVMLIBS += -ldevmapper
endif

include ../make.tmpl

lvm: $(OBJECTS) lvm.o $(top_srcdir)/lib/liblvm.a
	$(CC) -o lvm $(OBJECTS) lvm.o $(LD_FLAGS) $(LVMLIBS) $(LIBS)

liblvm2cmd.a: $(top_srcdir)/lib/liblvm.a $(OBJECTS)
	cat $(top_srcdir)/lib/liblvm.a > $@
	$(AR) rs $@ $(OBJECTS)

liblvm2cmd.so: liblvm2cmd.a $(LD_DEPS)
	$(CC) -o liblvm2cmd.so $(SOFLAG) $(CLDFLAGS) \
		$(CLDWHOLEARCHIVE) liblvm2cmd.a $(CLDNOWHOLEARCHIVE)

.commands: commands.h cmdnames.h Makefile
	$(CC) -E -P cmdnames.h 2> /dev/null | \
		egrep -v '^ *(|#.*|dumpconfig|help|pvdata|version) *$$' > .commands

.PHONY: install_lvm_tools install_cmdlib

install_cmdlib: $(TARGETS)
	$(INSTALL) -D -o $(OWNER) -g $(GROUP) -m 555 $(STRIP) liblvm2cmd.so \
		$(libdir)/liblvm2cmd.so.$(LIB_VERSION)
	$(LN_S) -f liblvm2cmd.so.$(LIB_VERSION) $(libdir)/liblvm2cmd.so
	$(INSTALL) -D -o $(OWNER) -g $(GROUP) -m 444 lvm2cmd.h \
		$(includedir)/lvm2cmd.h

install_lvm_tools: $(TARGETS)
	$(INSTALL) -D -o $(OWNER) -g $(GROUP) -m 555 $(STRIP) lvm \
		$(sbindir)/lvm
	@echo Creating symbolic links for individual commands in $(sbindir)
	@( \
		for v in `cat .commands`; do \
			cd $(sbindir); \
			$(LN_S) -f lvm $$v; \
		done; \
	)

install: $(INSTALL_TARGETS)

